@using ParaglidingFlightLogWeb.ViewModels
@using ParaglidingFlightLogWeb.Services
@rendermode InteractiveServer
@inject ILogger<CreateNewManualFlight> Logger
@inject DialogService DialogService
@if (_flightToCreate is null)
{
    return;
}
<MyDatePicker Label="Take Off Time" @bind-Value="@_flightToCreate.TakeOffDateTime" />
<RadzenTimeSpanPicker @bind-Value="@_flightToCreate.FlightDuration" AllowClear="true" AllowInput="true" ShowPopupButton="true" FieldPrecision="TimeSpanUnit.Second" Name="" />
<RadzenFormField Text="Glider" Variant="Variant.Outlined">
    <RadzenDropDown AllowFiltering="true"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    Data=@ViewModel.GliderListViewModel
                                        @bind-Value=@_flightToCreate.Glider Class="w-100" />
</RadzenFormField>
<RadzenFormField Text="Site" Variant="Variant.Outlined">
    <RadzenDropDown AllowFiltering="true"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    Data=@ViewModel.SiteListViewModel
                                        @bind-Value=@_flightToCreate.TakeOffSite Class="w-100" />
    
</RadzenFormField>
<RadzenFormField Text="Objective" Variant="Variant.Outlined">
    <RadzenDropDown Data="@CoreService.GetObjectiveList()" @bind-Value=@_flightToCreate.Objective Class="w-100" />
</RadzenFormField>


<RadzenTextArea Placeholder="Comment" @bind-Value=_flightToCreate.Comment Class="w-100" Rows="10" />

<RadzenStack Orientation="Orientation.Horizontal">
    <RadzenButton Icon="check" Click="WriteNewFlight"/>
    <RadzenButton Icon="cancel" Click="RevertFlightCreation"/>
</RadzenStack>
@code {
    /// <summary>
    /// Class to link to the model
    /// </summary>
    [Parameter] public CoreService ViewModel { get; set; } = null!;
    
    private FlightViewModel? _flightToCreate;
    /// <inheritdoc/>
    protected override async Task OnParametersSetAsync()
    {
        _flightToCreate = await ViewModel.CreateNewFlightViewModelAsync();
        Logger.LogInformation("Instanciate new flight to create with id {FlightId}", _flightToCreate.FlightID);
    }

    private void RevertFlightCreation()
    {
        Logger.LogInformation("Revert flight creation");
        if (_flightToCreate is null)
        {
            Logger.LogError("Flight to create is null");
            return;
        }
        ViewModel.FlightListViewModel.Remove(_flightToCreate);
        DialogService.Close();
    }

    private async Task WriteNewFlight()
    {
        Logger.LogInformation("Write new flight with id {FlightId}", _flightToCreate.FlightID);
        if (_flightToCreate is null)
        {
            Logger.LogError("Flight to create is null");
            return;
        }
        await _flightToCreate.UpdateOrCreateFlightInDb();
        DialogService.Close();
    }

}